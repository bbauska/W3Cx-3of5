import deepFreeze from"deep-freeze-es6";import Response from"./lib/response.js";import TokenTreeEmitter from"./lib/token_tree.js";import*as regex from"./lib/regex.js";import*as utils from"./lib/utils.js";import*as MODES from"./lib/modes.js";import{compileLanguage}from"./lib/mode_compiler.js";import*as packageJSON from"../package.json";import*as logger from"./lib/logger.js";import HTMLInjectionError from"./lib/html_injection_error.js";const escape=utils.escapeHTML,inherit=utils.inherit,NO_MATCH=Symbol("nomatch"),MAX_KEYWORD_HITS=7,HLJS=function(e){const n=Object.create(null),t=Object.create(null),i=[];let r=!0;const o="Could not find the language '{}', did you forget to load/include a language module?",l={disableAutodetect:!0,name:"Plain text",contains:[]};let a={ignoreUnescapedHTML:!1,throwUnescapedHTML:!1,noHighlightRe:/^(no-?highlight)$/i,languageDetectRe:/\blang(?:uage)?-([\w-]+)\b/i,classPrefix:"hljs-",cssSelector:"pre code",languages:null,__emitter:TokenTreeEmitter};function g(e){return a.noHighlightRe.test(e)}function s(e,n,t){let i="",r="";"object"==typeof n?(i=e,t=n.ignoreIllegals,r=n.language):(logger.deprecated("10.7.0","highlight(lang, code, ...args) has been deprecated."),logger.deprecated("10.7.0","Please use highlight(code, options) instead.\nhttps://github.com/highlightjs/highlight.js/issues/2277"),r=e,i=n),void 0===t&&(t=!0);const o={code:i,language:r};w("before:highlight",o);const l=o.result?o.result:c(o.language,o.code,t);return l.code=o.code,w("after:highlight",l),l}function c(e,t,i,l){const g=Object.create(null);function s(){if(!T.keywords)return void S.addText(O);let e=0;T.keywordPatternRe.lastIndex=0;let n=T.keywordPatternRe.exec(O),t="";for(;n;){t+=O.substring(e,n.index);const r=y.case_insensitive?n[0].toLowerCase():n[0],o=(i=r,T.keywords[i]);if(o){const[e,i]=o;if(S.addText(t),t="",g[r]=(g[r]||0)+1,g[r]<=7&&(j+=i),e.startsWith("_"))t+=n[0];else{const t=y.classNameAliases[e]||e;d(n[0],t)}}else t+=n[0];e=T.keywordPatternRe.lastIndex,n=T.keywordPatternRe.exec(O)}var i;t+=O.substring(e),S.addText(t)}function h(){null!=T.subLanguage?function(){if(""===O)return;let e=null;if("string"==typeof T.subLanguage){if(!n[T.subLanguage])return void S.addText(O);e=c(T.subLanguage,O,!0,E[T.subLanguage]),E[T.subLanguage]=e._top}else e=u(O,T.subLanguage.length?T.subLanguage:null);T.relevance>0&&(j+=e.relevance),S.__addSublanguage(e._emitter,e.language)}():s(),O=""}function d(e,n){""!==e&&(S.startScope(n),S.addText(e),S.endScope())}function f(e,n){let t=1;const i=n.length-1;for(;t<=i;){if(!e._emit[t]){t++;continue}const i=y.classNameAliases[e[t]]||e[t],r=n[t];i?d(r,i):(O=r,s(),O=""),t++}}function m(e,n){return e.scope&&"string"==typeof e.scope&&S.openNode(y.classNameAliases[e.scope]||e.scope),e.beginScope&&(e.beginScope._wrap?(d(O,y.classNameAliases[e.beginScope._wrap]||e.beginScope._wrap),O=""):e.beginScope._multi&&(f(e.beginScope,n),O="")),T=Object.create(e,{parent:{value:T}}),T}function b(e,n,t){let i=regex.startsWith(e.endRe,t);if(i){if(e["on:end"]){const t=new Response(e);e["on:end"](n,t),t.isMatchIgnored&&(i=!1)}if(i){for(;e.endsParent&&e.parent;)e=e.parent;return e}}if(e.endsWithParent)return b(e.parent,n,t)}function w(e){return 0===T.matcher.regexIndex?(O+=e[0],1):(N=!0,0)}function x(e){const n=e[0],i=t.substring(e.index),r=b(T,e,i);if(!r)return NO_MATCH;const o=T;T.endScope&&T.endScope._wrap?(h(),d(n,T.endScope._wrap)):T.endScope&&T.endScope._multi?(h(),f(T.endScope,e)):o.skip?O+=n:(o.returnEnd||o.excludeEnd||(O+=n),h(),o.excludeEnd&&(O=n));do{T.scope&&S.closeNode(),T.skip||T.subLanguage||(j+=T.relevance),T=T.parent}while(T!==r.parent);return r.starts&&m(r.starts,e),o.returnEnd?0:n.length}let _={};function L(n,o){const l=o&&o[0];if(O+=n,null==l)return h(),0;if("begin"===_.type&&"end"===o.type&&_.index===o.index&&""===l){if(O+=t.slice(o.index,o.index+1),!r){const n=new Error(`0 width match regex (${e})`);throw n.languageName=e,n.badRule=_.rule,n}return 1}if(_=o,"begin"===o.type)return function(e){const n=e[0],t=e.rule,i=new Response(t),r=[t.__beforeBegin,t["on:begin"]];for(const t of r)if(t&&(t(e,i),i.isMatchIgnored))return w(n);return t.skip?O+=n:(t.excludeBegin&&(O+=n),h(),t.returnBegin||t.excludeBegin||(O=n)),m(t,e),t.returnBegin?0:n.length}(o);if("illegal"===o.type&&!i){const e=new Error('Illegal lexeme "'+l+'" for mode "'+(T.scope||"<unnamed>")+'"');throw e.mode=T,e}if("end"===o.type){const e=x(o);if(e!==NO_MATCH)return e}if("illegal"===o.type&&""===l)return 1;if(H>1e5&&H>3*o.index){throw new Error("potential infinite loop, way more iterations than matches")}return O+=l,l.length}const y=p(e);if(!y)throw logger.error(o.replace("{}",e)),new Error('Unknown language: "'+e+'"');const k=compileLanguage(y);let v="",T=l||k;const E={},S=new a.__emitter(a);!function(){const e=[];for(let n=T;n!==y;n=n.parent)n.scope&&e.unshift(n.scope);e.forEach((e=>S.openNode(e)))}();let O="",j=0,M=0,H=0,N=!1;try{if(y.__emitTokens)y.__emitTokens(t,S);else{for(T.matcher.considerAll();;){H++,N?N=!1:T.matcher.considerAll(),T.matcher.lastIndex=M;const e=T.matcher.exec(t);if(!e)break;const n=L(t.substring(M,e.index),e);M=e.index+n}L(t.substring(M))}return S.finalize(),v=S.toHTML(),{language:e,value:v,relevance:j,illegal:!1,_emitter:S,_top:T}}catch(n){if(n.message&&n.message.includes("Illegal"))return{language:e,value:escape(t),illegal:!0,relevance:0,_illegalBy:{message:n.message,index:M,context:t.slice(M-100,M+100),mode:n.mode,resultSoFar:v},_emitter:S};if(r)return{language:e,value:escape(t),illegal:!1,relevance:0,errorRaised:n,_emitter:S,_top:T};throw n}}function u(e,t){t=t||a.languages||Object.keys(n);const i=function(e){const n={value:escape(e),illegal:!1,relevance:0,_top:l,_emitter:new a.__emitter(a)};return n._emitter.addText(e),n}(e),r=t.filter(p).filter(b).map((n=>c(n,e,!1)));r.unshift(i);const o=r.sort(((e,n)=>{if(e.relevance!==n.relevance)return n.relevance-e.relevance;if(e.language&&n.language){if(p(e.language).supersetOf===n.language)return 1;if(p(n.language).supersetOf===e.language)return-1}return 0})),[g,s]=o,u=g;return u.secondBest=s,u}function h(e){let n=null;const i=function(e){let n=e.className+" ";n+=e.parentNode?e.parentNode.className:"";const t=a.languageDetectRe.exec(n);if(t){const n=p(t[1]);return n||(logger.warn(o.replace("{}",t[1])),logger.warn("Falling back to no-highlight mode for this block.",e)),n?t[1]:"no-highlight"}return n.split(/\s+/).find((e=>g(e)||p(e)))}(e);if(g(i))return;if(w("before:highlightElement",{el:e,language:i}),e.dataset.highlighted)return void console.log("Element previously highlighted. To highlight again, first unset `dataset.highlighted`.",e);if(e.children.length>0&&(a.ignoreUnescapedHTML||(console.warn("One of your code blocks includes unescaped HTML. This is a potentially serious security risk."),console.warn("https://github.com/highlightjs/highlight.js/wiki/security"),console.warn("The element with unescaped HTML:"),console.warn(e)),a.throwUnescapedHTML)){throw new HTMLInjectionError("One of your code blocks includes unescaped HTML.",e.innerHTML)}n=e;const r=n.textContent,l=i?s(r,{language:i,ignoreIllegals:!0}):u(r);e.innerHTML=l.value,e.dataset.highlighted="yes",function(e,n,i){const r=n&&t[n]||i;e.classList.add("hljs"),e.classList.add(`language-${r}`)}(e,i,l.language),e.result={language:l.language,re:l.relevance,relevance:l.relevance},l.secondBest&&(e.secondBest={language:l.secondBest.language,relevance:l.secondBest.relevance}),w("after:highlightElement",{el:e,result:l,text:r})}let d=!1;function f(){if("loading"===document.readyState)return void(d=!0);document.querySelectorAll(a.cssSelector).forEach(h)}function p(e){return e=(e||"").toLowerCase(),n[e]||n[t[e]]}function m(e,{languageName:n}){"string"==typeof e&&(e=[e]),e.forEach((e=>{t[e.toLowerCase()]=n}))}function b(e){const n=p(e);return n&&!n.disableAutodetect}function w(e,n){const t=e;i.forEach((function(e){e[t]&&e[t](n)}))}"undefined"!=typeof window&&window.addEventListener&&window.addEventListener("DOMContentLoaded",(function(){d&&f()}),!1),Object.assign(e,{highlight:s,highlightAuto:u,highlightAll:f,highlightElement:h,highlightBlock:function(e){return logger.deprecated("10.7.0","highlightBlock will be removed entirely in v12.0"),logger.deprecated("10.7.0","Please use highlightElement now."),h(e)},configure:function(e){a=inherit(a,e)},initHighlighting:()=>{f(),logger.deprecated("10.6.0","initHighlighting() deprecated.  Use highlightAll() now.")},initHighlightingOnLoad:function(){f(),logger.deprecated("10.6.0","initHighlightingOnLoad() deprecated.  Use highlightAll() now.")},registerLanguage:function(t,i){let o=null;try{o=i(e)}catch(e){if(logger.error("Language definition for '{}' could not be registered.".replace("{}",t)),!r)throw e;logger.error(e),o=l}o.name||(o.name=t),n[t]=o,o.rawDefinition=i.bind(null,e),o.aliases&&m(o.aliases,{languageName:t})},unregisterLanguage:function(e){delete n[e];for(const n of Object.keys(t))t[n]===e&&delete t[n]},listLanguages:function(){return Object.keys(n)},getLanguage:p,registerAliases:m,autoDetection:b,inherit:inherit,addPlugin:function(e){!function(e){e["before:highlightBlock"]&&!e["before:highlightElement"]&&(e["before:highlightElement"]=n=>{e["before:highlightBlock"](Object.assign({block:n.el},n))}),e["after:highlightBlock"]&&!e["after:highlightElement"]&&(e["after:highlightElement"]=n=>{e["after:highlightBlock"](Object.assign({block:n.el},n))})}(e),i.push(e)},removePlugin:function(e){const n=i.indexOf(e);-1!==n&&i.splice(n,1)}}),e.debugMode=function(){r=!1},e.safeMode=function(){r=!0},e.versionString=packageJSON.version,e.regex={concat:regex.concat,lookahead:regex.lookahead,either:regex.either,optional:regex.optional,anyNumberOfTimes:regex.anyNumberOfTimes};for(const e in MODES)"object"==typeof MODES[e]&&deepFreeze(MODES[e]);return Object.assign(e,MODES),e},highlight=HLJS({});highlight.newInstance=()=>HLJS({});export default highlight;
